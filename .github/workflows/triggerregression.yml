name: Maven Test Pipeline

on:
  workflow_call:

jobs:
  test-execution:
    runs-on: ubuntu-latest
    timeout-minutes: 350
    steps:
      - uses: actions/checkout@v4

      - name: Detect Java version
        id: detect-java
        run: |
          JAVA_VERSION=$(grep -oPm1 "(?<=<java.version>)[^<]+" pom.xml || \
                        grep -oPm1 "(?<=<maven.compiler.source>)[^<]+" pom.xml || \
                        grep -oPm1 "(?<=<maven.compiler.target>)[^<]+" pom.xml || \
                        echo "11")
          # Validate version format
          if [[ ! $JAVA_VERSION =~ ^[0-9]+$ ]]; then
            echo "Invalid Java version detected: $JAVA_VERSION, defaulting to 11"
            JAVA_VERSION="11"
          fi
          echo "Detected Java version: $JAVA_VERSION"
          echo "JAVA_VERSION=$JAVA_VERSION" >> $GITHUB_ENV
        
      - name: Set Up Java with Maven
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: ''
          
      - name: Run Maven Tests
        run: |
          export PATH=$PWD/maven/apache-maven-3.8.4/bin:$PATH
          mvn clean test -Dspring.profiles.active=dev -D spring.country.code=Latam -Dcucumber.filter.tags="@globalsonew and @latam"

      - name: Upload Cucumber Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: CucumberReports
          path: '**/results/**'

  parse-reports:
    needs: test-execution
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: CucumberReports
          path: ${{ github.workspace }}/artifact

      - name: Parse Reports
        run: bash gs-api/scripts/report-parser.sh
        env:
          ARTIFACT_DIRECTORY: ${{ github.workspace }}/artifact
          ENV: '-Dspring.profiles.active=dev -D spring.country.code=Latam'
          TAGS: '-Dcucumber.filter.tags="@globalsonew and @latam"'
